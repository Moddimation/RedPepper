<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Project RedPepper: Decompilation of Super Mario 3D Land.">
    <link rel="stylesheet" href="https://prp.moddi.dev/assets/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito&disp=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bungee&disp=swap" rel="stylesheet">
    <link rel="icon" href="https://prp.moddi.dev/assets/favicon.ico" type="image/x-icon">
    <title>File seadDisposer.h - RedPepper Wiki</title>
  </head>
  <body>
    <div class="container">
      <nav>
        <ul>
        </ul>
      </nav>

      <div id="bar">

          <a id="barTitle" href="https://prp.moddi.dev/"><b>Project RedPepper</b></a>
            <li class="nav-item">
                <button onclick="window.location.href='https://prp.moddi.dev/files/'">
                  Files
                </button>
            </li>
            <li class="nav-item">
                <button onclick="window.location.href='https://prp.moddi.dev/classes/'">
                  Classes
                </button>
            </li>
            <li class="nav-item">
                <button onclick="window.location.href='https://prp.moddi.dev/wiki/'">
                  Full Wiki
                </button>
            </li>
            <li class="nav-item">
                <div class="dropdown">
                  <button class="dropdown-btn"
                          onclick="window.location.href='https://prp.moddi.dev/ver/'">
                    Versions
                  </button>
                  <ul class="dropdown-menu"> 
                      <li>
                        <button onclick="window.location.href='https://prp.moddi.dev/ver/eu/'">
                          EU
                        </button>
                      </li> 
                      <li>
                        <button onclick="window.location.href='https://prp.moddi.dev/ver/eu_d.md'">
                          EU D
                        </button>
                      </li> 
                      <li>
                        <button onclick="window.location.href='https://prp.moddi.dev/ver/jp.md'">
                          JP
                        </button>
                      </li> 
                      <li>
                        <button onclick="window.location.href='https://prp.moddi.dev/ver/jp_d.md'">
                          JP D
                        </button>
                      </li> 
                      <li>
                        <button onclick="window.location.href='https://prp.moddi.dev/ver/us_0.md'">
                          US R0
                        </button>
                      </li> 
                      <li>
                        <button onclick="window.location.href='https://prp.moddi.dev/ver/us_1.md'">
                          US R1
                        </button>
                      </li> 
                      <li>
                        <button onclick="window.location.href='https://prp.moddi.dev/ver/us_d.md'">
                          US D
                        </button>
                      </li> 
                      <li>
                        <button onclick="window.location.href='https://prp.moddi.dev/ver/cn.md'">
                          CN
                        </button>
                      </li> 
                      <li>
                        <button onclick="window.location.href='https://prp.moddi.dev/ver/kr.md'">
                          KR
                        </button>
                      </li> 
                      <li>
                        <button onclick="window.location.href='https://prp.moddi.dev/ver/tw.md'">
                          TW
                        </button>
                      </li>
                  </ul>
                </div>
            </li>

      </div>
      
      <h1 id="file-seaddisposerh">File seadDisposer.h</h1>
<p><a href="../files/"><strong>File List</strong></a> <strong>&gt;</strong> <a href="../dir_778a3e0db70a4aafcf2800db5bd87e35/"><strong>heap</strong></a> <strong>&gt;</strong> <a href="../sead_disposer_8h/"><strong>seadDisposer.h</strong></a></p>
<p><a href="../sead_disposer_8h/">Go to the documentation of this file</a></p>
<pre><code class="language-C++">#ifndef SEAD_DISPOSER_H_
#define SEAD_DISPOSER_H_

#include &lt;basis/seadNew.h&gt;
#include &lt;basis/seadRawPrint.h&gt;
#include &lt;basis/seadTypes.h&gt;
#include &lt;container/seadListImpl.h&gt;

namespace sead {
class Heap;

class IDisposer {
public:
    enum HeapNullOption {
        // disposer_heap must not be nullptr for this option.
        HeapNullOption_AlwaysUseSpecifiedHeap = 0,
        HeapNullOption_UseSpecifiedOrContainHeap = 1,
        HeapNullOption_DoNotAppendDisposerIfNoHeapSpecified = 2,
        HeapNullOption_UseSpecifiedOrCurrentHeap = 3,
    };

    IDisposer();
    explicit IDisposer(Heap* disposer_heap,
                       HeapNullOption option = HeapNullOption_UseSpecifiedOrCurrentHeap);
    virtual ~IDisposer();

    static u32 getListNodeOffset() { return 8; }

protected:
    Heap* getDisposerHeap_() const { return mDisposerHeap; }

private:
    friend class Heap;

    Heap* mDisposerHeap;
    ListNode mListNode;
};

}  // namespace sead

#define SEAD_INSTANCE(CLASS) (CLASS::instance())

#define SEAD_SINGLETON_DISPOSER(CLASS)                                                             \
public:                                                                                            \
    class SingletonDisposer_ : public sead::IDisposer {                                            \
    public:                                                                                        \
        virtual ~SingletonDisposer_();                                                             \
                                                                                                   \
        static SingletonDisposer_* sStaticDisposer;                                                \
        SingletonDisposer_(sead::Heap* disposer_heap,                                              \
                           sead::IDisposer::HeapNullOption option =                                \
                               sead::IDisposer::HeapNullOption_UseSpecifiedOrCurrentHeap)          \
            : IDisposer(disposer_heap, option) {}                                                  \
    };                                                                                             \
                                                                                                   \
    static CLASS* instance() {                                                                     \
        return sInstance;                                                                          \
    }                                                                                              \
    static CLASS* createInstance(sead::Heap* heap);                                                \
    static void deleteInstance();                                                                  \
                                                                                                   \
protected:                                                                                         \
    static CLASS* sInstance;                                                                       \
                                                                                                   \
    friend class SingletonDisposer_;                                                               \
                                                                                                   \
    /* FIXME: this should just use std::aligned_storage_t with a proper alignment value. */        \
    u32 mSingletonDisposerBuf_[sizeof(SingletonDisposer_) / sizeof(u32)];

#define SEAD_CREATE_SINGLETON_INSTANCE(CLASS)                                                      \
    CLASS* CLASS::createInstance(sead::Heap* heap) {                                               \
        if (!sInstance) {                                                                          \
            u8* buffer = new (heap, /*alignof(CLASS)*/ 4) u8[sizeof(CLASS)];                       \
            SEAD_ASSERT_MSG(!SingletonDisposer_::sStaticDisposer, &quot;Create Singleton Twice (%s).&quot;,  \
                            #CLASS);                                                               \
            u8* disposer_buffer = buffer + offsetof(CLASS, mSingletonDisposerBuf_);                \
                                                                                                   \
            /* FIXME: do this after creating the instance to ensure the disposer is not clobbered  \
             * by CLASS's constructor */                                                           \
            SingletonDisposer_::sStaticDisposer = new (disposer_buffer) SingletonDisposer_(heap);  \
            /* Note: When compiling as C++03 (or a newer standard), this must not be `new CLASS()` \
             * as that will value initialize (C++17 [dcl.init]/11), which eventually leads to zero \
             * initialisation when CLASS has no user-provided constructor (C++17 [dcl.init]/8).    \
             * This is dangerous because the singleton disposer would get clobbered.               \
             */                                                                                    \
            sInstance = new (buffer) CLASS;                                                        \
        } else {                                                                                   \
            SEAD_ASSERT_MSG(false, &quot;Create Singleton Twice (%s) : addr %p&quot;, #CLASS, sInstance);    \
        }                                                                                          \
                                                                                                   \
        return CLASS::sInstance;                                                                   \
    }

#define SEAD_DELETE_SINGLETON_INSTANCE(CLASS)                                                      \
    void CLASS::deleteInstance() {                                                                 \
        SingletonDisposer_* staticDisposer = SingletonDisposer_::sStaticDisposer;                  \
        if (SingletonDisposer_::sStaticDisposer != NULL) {                                         \
            SingletonDisposer_::sStaticDisposer = NULL;                                            \
            staticDisposer-&gt;~SingletonDisposer_();                                                 \
                                                                                                   \
            delete sInstance;                                                                      \
                                                                                                   \
            sInstance = NULL;                                                                      \
        }                                                                                          \
    }

#define SEAD_SINGLETON_DISPOSER_IMPL(CLASS)                                                        \
    CLASS::SingletonDisposer_::~SingletonDisposer_() {                                             \
        if (this == sStaticDisposer) {                                                             \
            sStaticDisposer = nullptr;                                                             \
            CLASS::sInstance-&gt;~CLASS();                                                            \
            CLASS::sInstance = nullptr;                                                            \
        }                                                                                          \
    }                                                                                              \
    SEAD_CREATE_SINGLETON_INSTANCE(CLASS)                                                          \
    SEAD_DELETE_SINGLETON_INSTANCE(CLASS)                                                          \
    CLASS* CLASS::sInstance = NULL;                                                                \
    CLASS::SingletonDisposer_* CLASS::SingletonDisposer_::sStaticDisposer = NULL;

#endif  // SEAD_DISPOSER_H_
</code></pre>
        <script src="../../search/main.js"></script>
    </div>
  </body>
</html>